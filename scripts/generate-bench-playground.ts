import { mkdir, rm, writeFile } from 'node:fs/promises'
import { dirname, join } from 'node:path'
import { fileURLToPath } from 'node:url'

const __dirname = dirname(fileURLToPath(import.meta.url))

const DEFAULT_COUNT = 500
const TWOSLASH_COUNT = 50
const argCount = Number.parseInt(process.argv[2] ?? '', 10)
const pageCount = Number.isFinite(argCount) ? argCount : DEFAULT_COUNT

const benchDir = process.argv[3] ?? join(__dirname, '../playgrounds/default/docs/pages/bench')

const pad = (value: number, size = 3) => String(value).padStart(size, '0')

const pageBody = (i: number, includeTwoslash: boolean) => {
  const title = `Bench Page ${i}`
  return `---
title: ${title}
description: Synthetic bench page ${i}
---

# ${title}

This page is autogenerated for build benchmarks.

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer in nisl quis velit faucibus ultrices. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia curae.

\`\`\`ts
export const pageNumber = ${i}
export const payload = { text: '${title}', value: ${i} }
\`\`\`
${
  includeTwoslash
    ? `
\`\`\`ts twoslash
type User = { id: number; name: string; email?: string }
const user: User = { id: 1, name: 'Ada', email: 'ada@example.com' }
user.email
\`\`\`
`
    : ''
}
`
}

async function main() {
  await rm(benchDir, { recursive: true, force: true })
  await mkdir(benchDir, { recursive: true })

  const links: string[] = []

  for (let i = 1; i <= pageCount; i += 1) {
    const slug = `page-${pad(i)}`
    const filePath = join(benchDir, `${slug}.mdx`)
    const includeTwoslash = i <= Math.min(pageCount, TWOSLASH_COUNT)
    await writeFile(filePath, pageBody(i, includeTwoslash), 'utf8')
    links.push(`- [Bench Page ${i}](./${slug})`)
  }

  const indexContent = `---
title: Bench Index (${pageCount} pages)
description: Autogenerated list of benchmark pages
---

# Benchmark Pages

Generated ${pageCount} pages for build/perf benchmarks.

${links.join('\n')}
`

  await writeFile(join(benchDir, 'index.mdx'), indexContent, 'utf8')
}

main().catch((error) => {
  console.error(error)
  process.exitCode = 1
})
